name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies (bun)
        run: bun install --frozen-lockfile

      - name: Run type check
        run: bun run typecheck

      - name: Build packages
        run: bun run build

      - name: Run tests (bun)
        run: bun test --no-coverage
        timeout-minutes: 10

      - name: Check test coverage thresholds
        run: |
          cd packages/core
          bun run test:coverage:check

      - name: "E2E: Worker + quickjs-emscripten"
        run: |
          echo "Running worker e2e (requires quickjs-emscripten)"
          bun test packages/core/src/runtime/engine.worker.e2e.test.ts || (echo "Worker e2e failed" && exit 1)

      - name: Test CLI executable
        run: |
          echo "Testing CLI version command..."
          node packages/cli/dist/index.js --version

      - name: Test CLI build + analyze (strict guard)
        run: |
          echo "Creating test plugin..."
          mkdir -p test-plugin
          cat > test-plugin/plugin.tsx << 'EOF'
          import { View, Text } from 'rill/sdk';

          export default function TestPlugin() {
            return (
              <View>
                <Text>Hello from test plugin</Text>
              </View>
            );
          }
          EOF

          echo "Building test plugin..."
          node packages/cli/dist/index.js build test-plugin/plugin.tsx -o test-plugin/bundle.js

          echo "Analyzing built bundle (should PASS)..."
          node packages/cli/dist/index.js analyze test-plugin/bundle.js --fail-on-violation --treat-eval-as-violation --treat-dynamic-non-literal-as-violation

          echo "Creating bad bundle (should FAIL analyze)..."
          echo "require('rill/sdk');" > test-plugin/bad-bundle.js
          set +e
          node packages/cli/dist/index.js analyze test-plugin/bad-bundle.js --fail-on-violation
          if [ $? -eq 0 ]; then
            echo "❌ Analyze should have failed but passed"
            exit 1
          fi
          set -e

          echo "✅ CLI build+analyze tests passed"

      - name: Check bundle size
        run: |
          echo "Bundle sizes:"
          du -h packages/core/dist/runtime/index.js || true
          du -h packages/core/dist/sdk/index.js || true
          du -h packages/cli/dist/index.js || true
